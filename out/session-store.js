// Generated by CoffeeScript 1.6.2
var P2PStore, Peers, connect, difflet, getLocalIp, guid, os, _,
  __hasProp = {}.hasOwnProperty,
  __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

connect = require("connect");

_ = require("lodash");

difflet = require("difflet");

Peers = require("./peers");

guid = function() {
  return (Math.random() * Math.pow(2, 32)).toString(16);
};

os = require("os");

getLocalIp = function(regex) {
  var addr, addrs, name, _i, _len, _ref;

  _ref = os.networkInterfaces();
  for (name in _ref) {
    addrs = _ref[name];
    for (_i = 0, _len = addrs.length; _i < _len; _i++) {
      addr = addrs[_i];
      if (addr.family === 'IPv4' && (!regex || regex.test(addr.address))) {
        return addr.address;
      }
    }
  }
  return null;
};

module.exports = P2PStore = (function(_super) {
  __extends(P2PStore, _super);

  P2PStore.prototype.name = "P2PStore";

  function P2PStore(options) {
    if (!options) {
      this.err("Must specify options");
    }
    P2PStore.__super__.constructor.call(this, options);
    if (!options.port) {
      this.err("Must specify a port");
    }
    _.bindAll(this);
    this.host = getLocalIp(/^172/) || "127.0.0.1";
    this.port = options.port;
    this.peers = new Peers(this, options.peers);
    this.sessions = {};
    this.lasts = {};
  }

  P2PStore.prototype.get = function(sid, fn) {
    this.log("get: " + sid);
    return fn(null, this.sessions[sid]);
  };

  P2PStore.prototype.set = function(sid, sess, fn) {
    this._set(sid, sess);
    this.peers.send({
      method: "set",
      sid: sid,
      sess: sess
    });
    if (fn) {
      return fn(null);
    }
  };

  P2PStore.prototype._set = function(sid, sess) {
    this.log("set: " + sid);
    this.sessions[sid] = sess;
    return null;
  };

  P2PStore.prototype.destroy = function(sid, fn) {
    this._destroy(sid);
    this.peers.send({
      method: "destroy",
      sid: sid
    });
    if (fn) {
      return fn(null);
    }
  };

  P2PStore.prototype._destroy = function(sid) {
    this.log("delete: " + sid);
    delete this.sessions[sid];
    return null;
  };

  P2PStore.prototype.toString = function() {
    return "" + this.host + ":" + this.port + ": ";
  };

  P2PStore.prototype.err = function(str) {
    throw new Error("" + this + str);
  };

  P2PStore.prototype.log = function() {
    return console.log.apply(console, [this.toString()].concat(_.toArray(arguments)));
  };

  return P2PStore;

})(connect.session.Store);
